<link rel="import" href="../../../../bower_components/polymer/polymer.html">

<link rel="import" href="../../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../../bower_components/paper-autocomplete/paper-autocomplete.html">
<link rel="import" href="../../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../../../bower_components/iron-form/iron-form.html">
<link rel="import" href="../../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../../../../bower_components/paper-chip/paper-chip.html">
<link rel="import" href="../../../../bower_components/paper-chip/paper-chip-icons.html">

<link rel="import" href="../../../../element/file-upload/file-upload.html">
<link rel="import" href="../../../../element/storage/storage-adapter-resource-behaviour.html">

<link rel="import" href="../timeline-item/timeline-item.html">

<link rel="import" href="../../../../css/global-layout.html">
<link rel="import" href="../../../../css/global-styles.html">

<dom-module id="timeline-view-upsert">
    <template>
        <style>
            .pd-r {
                padding-right: 6px;
            }

            .search-timeslot {
                padding-right: 6px;
                padding-left: 6px;
                display: flex;
                align-items: center;
            }

            paper-button {
                height: 46px;
            }

            paper-button.save {
                margin-left: 10px;
            }

            .timeline {
                margin-top: 10px;
                height: 500px;
                display: flex;
                justify-content: flex-start;
                /* You can set flex-wrap and
                   flex-direction individually */
                flex-direction: column;
                flex-wrap: wrap;
                /* Or do it all in one line
                  with flex flow */
                flex-flow: column wrap;
                /* tweak where items line
                   up on the row
                   valid values are: flex-start,
                   flex-end, space-between,
                   space-around, stretch */
                align-content: flex-start;
                overflow-x: auto;
            }

            timeline-item-wc {
                margin-bottom: 6px;
                margin-right: 6px;
                align-self: flex-start
            }

        </style>
        <style include="global-layout"></style>
        <style include="global-style"></style>
        <slot name="header"></slot>
        <div id="container" class="flex flex-horizontal">
            <iron-form id="formTimeline" class="flex-1">
                <form method="post" action="">
                    <paper-input id="name" name="name" label="Name" value="{{resource.name}}" required></paper-input>
                    <paper-checkbox checked="{{resource.enableAudio}}" style="padding-top: 20px;">Enable audio <i>(working only on video resource)</i></paper-checkbox>
                    <div class="flex-horizontal flex" style="width: 100%;">
                        <div class="flex-basis-33">
                            <paper-input label="Start hours" value="{{resource.time.hours}}" type="number" required></paper-input>
                        </div>
                        <div class="pd-r"></div>
                        <div class="flex-basis-33">
                            <paper-input label="Start minutes" value="{{resource.time.minutes}}" type="number" required></paper-input>
                        </div>
                        <div class="pd-r"></div>
                        <div class="flex-basis-33">
                            <paper-input label="Start seconds" value="{{resource.time.seconds}}" type="number" required></paper-input>
                        </div>
                    </div>
                    <div class="flex flex-vertical-center">
                        <paper-card class="search-timeslot flex-1">
                            <div class="flex-1">
                                <paper-input label="Start hours" value="{{time.hours}}" type="number"></paper-input>
                            </div>
                            <div class="pd-r"></div>
                            <div class="flex-1">
                                <paper-input label="Start minutes"  min="0" max="60" value="{{time.minutes}}" type="number"></paper-input>
                            </div>
                            <div class="pd-r"></div>
                            <div class="flex-1">
                                <paper-input label="Start seconds" value="{{time.seconds}}" type="number"></paper-input>
                            </div>
                            <div class="pd-r"></div>
                            <div class="flex-1">
                                <paper-autocomplete
                                        id="autocompleteTimeslot"
                                        label="Timelosts"
                                        text-property="name"
                                        value-property="name"
                                        remote-source
                                        on-autocomplete-change="_searchTimeslotChanged">
                                    <template slot="autocomplete-custom-template">
                                        <style>
                                            :host {
                                                display: block;
                                            }

                                            paper-item.account-item {
                                                padding: 8px 16px;
                                            }

                                            .service-name {
                                                color: #333;
                                            }

                                            .service-description {
                                                margin-top: 4px;
                                                color: #999;
                                            }
                                        </style>
                                        <paper-item class="account-item" on-tap="_onSelect" role="option" aria-selected="false">
                                            <div>
                                                <div class="service-name">[[item.name]]</div>
                                                <div class="service-description">[[item.virtualMonitorReference.name]]</div>
                                            </div>
                                            <paper-ripple></paper-ripple>
                                        </paper-item>
                                    </template>
                                </paper-autocomplete>
                            </div>
                            <div class="pd-r"></div>
                            <paper-button  on-tap="addToTimeline" class="button-search">Add to timeline</paper-button>
                        </paper-card>
                        <paper-button on-tap="submitTimlineButton" class="save">{{labelAction}}</paper-button>
                    </div>
                    <div class="flex-horizontal flex">
                        <paper-autocomplete
                                id="bind"
                                label="Bind a timeline"
                                text-property="name"
                                value-property="name"
                                remote-source
                                on-autocomplete-selected="_selectBind"
                                on-autocomplete-change="_searchBindChanged">
                            <template slot="autocomplete-custom-template">
                                <style>
                                    :host {
                                        display: block;
                                    }

                                    paper-item.account-item {
                                        padding: 8px 16px;
                                    }

                                    .service-name {
                                        color: #333;
                                    }

                                    .service-description {
                                        margin-top: 4px;
                                        color: #999;
                                    }
                                </style>
                                <paper-item class="account-item" on-tap="_onSelect" role="option" aria-selected="false">
                                    <div>
                                        <div class="service-name">[[item.name]]</div>
                                    </div>
                                    <paper-ripple></paper-ripple>
                                </paper-item>
                            </template>
                        </paper-autocomplete>
                        <div id="listBind" class="flex flex-vertical-center"></div>
                    </div>
                    <div id="listItems" class="timeline flex-1">
                        <template is="dom-repeat" id="timelineItems" items="[[resource.timelineItems]]" as="timelineItem">
                            <timeline-item-wc timeline-item="{{timelineItem}}" on-remove="removeItem" on-remove-reference="removeItem"></timeline-item-wc>
                        </template>
                    </div>
                </form>
            </iron-form>
        </div>
    </template>

    <script>
        class ElementTimelineViewUpsert extends StorageAdapterResourceBehaviour {

            static get is() {
                return 'timeline-view-upsert';
            }

            static get properties() {
                return {

                    time: {
                        type: Object,
                        value: new Time()
                    },

                    labelAction: {
                        type: String,
                        value: 'Save'
                    },

                    storageName: {
                        type: String,
                        readOnly: true,
                        value: TimelineConfig.NAME_SERVICE

                    },

                    resource: {
                        type: Object,
                        notify: true,
                        value: new Timeline(),
                        observer: '_timelineChanged'
                    }
                }
            }

            _timelineChanged(newValue, oldValue) {

                if (!newValue || !newValue.id) {
                    return;
                }


                this.$.listBind.innerHTML = '';
                for (let cont = 0; newValue.binds.length > cont; cont++) {
                    this.appendBindChip(newValue.binds[cont]);
                }

                this.labelAction = newValue && newValue.id ? 'Update' : 'Save';
            }

            ready() {
                super.ready();
                this.$.formTimeline.addEventListener('iron-form-presubmit', this.submitTimeline.bind(this));

                window.addEventListener("resize", () => {
                    this._debouncer = Polymer.Debouncer.debounce(
                        this._debouncer,
                        Polymer.Async.timeOut.after(200), () => {
                            this._setHeightListItem();
                    });
                });
            }

            /**
             *  @private
             */
            _setHeightListItem() {
                let height = window.innerHeight - this.$.listItems.offsetTop - 10;
                this.$.listItems.style.height = `${height}px`;
            }

            /**
             * @param evt
             * @private
             */
            async _searchTimeslotChanged(evt) {

                let search = {};
                search.name = evt.detail.value;

                serviceManager.get('StoragePluginManager')
                    .get(TimeslotConfig.NAME_SERVICE)
                    .getAll(search)
                    .then((data) => {
                        evt.detail.target.suggestions(data);
                    })
                    .catch((err) => {
                            console.error(err)
                        }
                    );
            }

            /**
             * @param evt
             */
            submitTimlineButton(evt) {
                this.$.formTimeline.submit();
            }

            /**
             * @param evt
             */
            submitTimeline(evt) {
                evt.preventDefault();

                let method = this.getStoragePersistMethod();
                this.storage[method](this.resource)
                    .then((data) => {
                        serviceManager.get('PaperToastNotification').notify(method.charAt(0).toUpperCase() + method.slice(1) + ' timeline ');
                        if (method === 'save') {
                            this._reset();
                        }

                    })
                    .catch((err) => {
                            console.error(err)
                        }
                    );
            }

            /**
             * @param evt
             */
            addToTimeline(evt) {

                this.resource.addItem(this.time, this.$.autocompleteTimeslot._selectedOption);

                let list = this.resource.timelineItems;
                this.resource.timelineItems = [];
                this.$.timelineItems.render();
                this.resource.timelineItems = list;
                this.$.timelineItems.render();
                this.time = this.time.clone();

                this.$.autocompleteTimeslot.reset();
                this.$.autocompleteTimeslot._selectedOption = null;
                this._updateTimelineTimeWc(this.time);
            }

            /**
             * @param {Time} time
             */
            _updateTimelineTimeWc(time) {
                let item = this.shadowRoot.querySelector(`timeline-item-wc[identifier="${time.toString()}"]`);
                if (item) {
                    item.updateData();
                }
            }

            /**
             * @param evt
             * @private
             */
            _searchBindChanged(evt) {
                // TODO refactor search
                this.storage.getAll()
                    .then((data) => {

                        let filter = data.filter(
                            element => {
                                return element.name.search(new RegExp(evt.detail.value, 'i')) > -1 && element.id !== this.resource.id;
                            }
                        );

                        evt.detail.target.suggestions(
                            filter
                        );
                    })
                    .catch((err) => {
                            console.log(err)
                        }
                    );
            }


            _selectBind(evt) {
                let bind = TimelineReference.getReferenceFromEntity(evt.detail.option);
                this.resource.appendBind(bind);
                this.appendBindChip(bind);
                setTimeout(
                    () => {
                        this.$.bind.clear();
                    },
                    200
                );
            }

            /**
             * @param bind
             */
            appendBindChip(bind) {

                let chip = this._createChip(bind, 'name', 'timelineResource');
                chip.addEventListener('remove', this._removeBind.bind(this));
                this.$.listBind.appendChild(chip);
            };

            /**
             * @param evt
             * @private
             */
            _removeBind(evt) {
                this.resource.removeBind(evt.target.timelineResource);
                setTimeout(
                    () => {
                        this._recalculateChipIndex('listBind');
                    },
                    200
                );
            }

            /**
             * @param type
             */
            _recalculateChipIndex(type) {

                let child = this.$[type].querySelectorAll('paper-chip');
                for (let cont = 0; child.length > cont; cont++) {
                    child[cont].index = cont;
                }
            }

            /**
             * @param resource
             * @param labelProperty
             * @param nameInject
             * @return paper-chip
             * @private
             */
            _createChip(resource, labelProperty, nameInject) {

                let chip = document.createElement("paper-chip");
                chip.setAttribute('removable', true);
                chip.setAttribute('single-line', true);

                let div = document.createElement("div");
                div.setAttribute('slot', 'label');
                div.innerHTML = resource[labelProperty];

                chip.appendChild(div);
                chip[nameInject] = resource;

                return chip;
            }

            /**
             * @param evt
             */
            removeItem(evt) {

                this.resource.removeItem(evt.detail.timelineItem.time, evt.detail.timeslotReference);

                this._updateTimelineTimeWc(evt.detail.timelineItem.time);
                this.$.timelineItems.render();
            }

            /**
             * @private
             */
            _reset() {
                this.resource = new Timeline();
            }
        }

        window.customElements.define(ElementTimelineViewUpsert.is, ElementTimelineViewUpsert);

    </script>
</dom-module>
