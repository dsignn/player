<link rel="import" href="../../../../bower_components/polymer/polymer.html">

<link rel="import" href="../../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../../bower_components/paper-autocomplete/paper-autocomplete.html">
<link rel="import" href="../../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../../../bower_components/iron-form/iron-form.html">
<link rel="import" href="../../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../../../../bower_components/paper-chip/paper-chip.html">
<link rel="import" href="../../../../bower_components/paper-chip/paper-chip-input.html">
<link rel="import" href="../../../../bower_components/paper-chip/paper-chip-icons.html">
<link rel="import" href="../../../../bower_components/paper-material/paper-material.html">

<link rel="import" href="../../../../element/file-upload/file-upload.html">
<link rel="import" href="../../../../element/layout/view/storage-behaviour.html">

<link rel="import" href="../../../../css/global-layout.html">
<link rel="import" href="../../../../css/global-styles.html">

<dom-module id="video-panel-view-resource-upsert">
    <template>
        <style>
            paper-material {
                padding: 8px 12px;
                background-color: #fffff0;
                margin-right: 4px;
            }

            paper-material .title {
                font-size: 20px;
            }

            paper-material .subtitle {
                font-style: italic;
            }
        </style>
        <style include="global-layout"></style>
        <style include="global-style"></style>
        <slot name="header"></slot>
        <iron-form id="formPanelResource">
            <form method="post" action="">
                <div>
                    <paper-input id="name" name="name" label="Name" value="{{resource.name}}" required></paper-input>
                    <paper-input id="nameResource" name="name" label="Name resource" value="{{resource.resourceReference.name}}" required></paper-input>
                    <div class="flex flex-horizontal">
                        <paper-checkbox id="checkSingle" class="flex flex-vertical-end" style="padding-bottom: 10px; padding-right: 20px;" checked="{{resource.nested}}">
                            Single row content
                        </paper-checkbox>
                        <paper-autocomplete
                                style="flex: 1;"
                                id="panel"
                                label="Panel"
                                text-property="name"
                                value-property="name"
                                remote-source
                                on-autocomplete-selected="_autocompletePanelSelect"
                                on-autocomplete-change="_autocompletePanelChanged"
                                on-autocomplete-reset-blur="autocompletePanelReset">
                            <template slot="autocomplete-custom-template">
                                <style>
                                    :host {
                                        display: block;
                                    }

                                    paper-item.account-item {
                                        padding: 8px 16px;
                                    }

                                    .service-name {
                                        color: #333;
                                    }

                                    .service-description {
                                        margin-top: 4px;
                                        color: #999;
                                    }
                                </style>
                                <paper-item class="account-item" on-tap="_onSelect" role="option" aria-selected="false">
                                    <div>
                                        <div class="service-name">[[item.name]]</div>
                                        <div class="service-description">
                                            Width [[item.videoPanel.width]]px
                                            Height [[item.videoPanel.height]]px
                                        </div>
                                    </div>
                                    <paper-ripple></paper-ripple>
                                </paper-item>
                            </template>
                        </paper-autocomplete>
                    </div>
                    <div hidden$="{{!hideResourceSection}}">
                        <div id="single" hidden$="{{!resource.nested}}">
                            <paper-material class="flex-1">
                                <paper-autocomplete
                                        style="flex: 1;"
                                        id="singleResource"
                                        label="Select resource"
                                        text-property="name"
                                        value-property="name"
                                        remote-source
                                        on-autocomplete-selected="_autocompleteResourceSelect"
                                        on-autocomplete-change="_autocompleteResourceChanged">
                                    <template slot="autocomplete-custom-template">
                                        <style>
                                            :host {
                                                display: block;
                                            }

                                            paper-item.account-item {
                                                padding: 8px 16px;
                                            }

                                            .service-name {
                                                color: #333;
                                            }

                                            .service-description {
                                                margin-top: 4px;
                                                color: #999;
                                            }
                                        </style>
                                        <paper-item class="account-item" on-tap="_onSelect" role="option" aria-selected="false">
                                            <div>
                                                <div class="service-name">[[item.name]]</div>
                                                <div class="service-description">Width [[item.width]]px Height
                                                    [[item.height]]px
                                                </div>
                                            </div>
                                            <paper-ripple></paper-ripple>
                                        </paper-item>
                                    </template>
                                </paper-autocomplete>
                                <div id="singleSidelineResource" class="listClass">
                                    <template is="dom-repeat" items="[[resource.videoPanel.resources]]" as="resource">
                                        <paper-chip removable single-line index="{{index}}">
                                            {{resource.name}}
                                        </paper-chip>
                                    </template>
                                </div>
                            </paper-material>
                        </div>
                        <div id="multi" hidden$="{{resource.nested}}">
                            <div class="flex flex-horizontal">
                                <template is="dom-repeat" items="[[videoPanels]]" as="videoPanel">
                                    <paper-material videoPanel="videoPanel" class="flex-1" id="{{videoPanel.id}}">
                                        <div class="flex flex-horizontal-center title">{{videoPanel.name}}</div>
                                        <div class="flex flex-horizontal-center subtitle"> height {{videoPanel.height}} px - width {{videoPanel.width}} px</div>
                                        <paper-autocomplete
                                                label="Select resource"
                                                text-property="name"
                                                value-property="name"
                                                remote-source
                                                video-panel="{{videoPanel}}"
                                                on-autocomplete-selected="_autocompleteResourceSelect"
                                                on-autocomplete-change="_autocompleteResourceChanged">
                                            <template slot="autocomplete-custom-template">
                                                <style>
                                                    :host {
                                                        display: block;
                                                    }

                                                    paper-item.account-item {
                                                        padding: 8px 16px;
                                                    }

                                                    .service-name {
                                                        color: #333;
                                                    }

                                                    .service-description {
                                                        margin-top: 4px;
                                                        color: #999;
                                                    }
                                                </style>
                                                <paper-item class="account-item" on-tap="_onSelect" role="option"
                                                            aria-selected="false">
                                                    <div>
                                                        <div class="service-name">[[item.name]]</div>
                                                    </div>
                                                    <paper-ripple></paper-ripple>
                                                </paper-item>
                                            </template>
                                        </paper-autocomplete>
                                        <div class="listClass">
                                            <template is="dom-repeat" items="[[videoPanel.resources]]" as="resource">
                                                <paper-chip removable single-line index="{{index}}">
                                                    {{resource.name}}
                                                </paper-chip>
                                            </template>
                                        </div>
                                        <paper-checkbox checked="{{videoPanel.esclude}}">Esclude video panel</paper-checkbox>
                                    </paper-material>
                                </template>
                            </div>
                        </div>
                    </div>
                </div>
                <div>
                    <div class="flex flex-horizontal-end" style="margin-top: 20px;">
                        <paper-button on-tap="createResource">Create resource</paper-button>
                        <paper-button on-tap="submitSidelineResourceButton">{{labelAction}}</paper-button>
                    </div>
                </div>
            </form>
        </iron-form>
    </template>

    <script>
        class ElementVideoPanelViewResourceUpsert extends StorageBehaviour {

            static get is() {
                return 'video-panel-view-resource-upsert';
            }

            static get properties() {
                return {

                    resource: {
                        type: Object,
                        notify: true,
                        value: new PanelResource()
                    },

                    videoPanels: {
                        type: Array,
                        readOnly: true,
                        notify: true,
                        value: []
                    },

                    hideResourceSection: {
                        type: Boolean,
                        notify: true,
                        value: false
                    },

                    hideSingleSection: {
                        type: Boolean,
                        notify: true,
                        value: false
                    },

                    labelAction: {
                        type: String,
                        notify: true,
                        value: 'Save'
                    },

                    storageName: {
                        type: String,
                        readOnly: true,
                        value: VideoPanelConfig.RESOURCE_SERVICE

                    },
                }
            }

            static get observers() {
                return [
                    '_changeResource(resource)'
                ]
            }

            ready() {
                super.ready();

             //   this.storage.eventManager.on(dsign.storage.Storage.STORAGE_POST_SAVE, this._clearData.bind(this));
                this.$.formPanelResource.addEventListener('iron-form-presubmit', this.submitPanelResource.bind(this));
            }

            /**
             * @param {null|PanelResource} resource
             */
            _changeResource(resource) {
                if (!resource) {
                    this.labelAction ='Save';
                    return;
                }

                this.hideResourceSection = true;
                this._setVideoPanels(resource.hasVideoPanel()
                    ? resource.getVideoPanel().getVideoPanels()
                    : []
                );
                this.labelAction = resource.id ? 'Update' : 'Save';
            }

            /**
             * @param evt
             */
            _autocompletePanelChanged(evt) {

                serviceManager.get('StoragePluginManager')
                    .get(VideoPanelConfig.NAME_SERVICE)
                    .getAll({name: evt.detail.value})
                    .then((data) => {
                        evt.detail.target.suggestions(data);
                    });
            }

            /**
             * @param evt
             */
            _autocompletePanelSelect(evt) {

                this.hideResourceSection = true;
                let videoPanel = evt.detail.option.hasVideoPanel()
                    ? serviceManager.get('HydratorPluginManager')
                        .get('videoPanelResourceHydrator').hydrate(evt.detail.option.getVideoPanel())
                    : {};

                this.resource.setVideoPanel(videoPanel);

                this.$.singleResource.videoPanel = this.resource.getVideoPanel();
                this.notifyPath('resource.videoPanel.resources');

                this._setVideoPanels(this.resource.hasVideoPanel()
                    ? this.resource.getVideoPanel().getVideoPanels()
                    : []
                );
            }

            /**
             * @param evt
             */
            autocompletePanelReset(evt) {
                this.hideResourceSection = false;
                this.resource.setVideoPanel({});
            }

            /**
             *
             */
            createResource() {
                this.$.resourceGenerator.create();
            }

            /**
             * @param evt
             */
            _autocompleteResourceChanged(evt) {

                serviceManager.get('StoragePluginManager')
                    .get(ResourceConfig.NAME_SERVICE)
                    .getAll({name: evt.detail.value})
                    .then((data) => {
                        evt.detail.target.suggestions(data);
                });
            }
            /**
             * @param evt
             */

            _autocompleteResourceSelect(evt) {

                evt.target.videoPanel.appendResource(
                    new ResourceReference(
                        evt.detail.option.id,
                        evt.detail.option.name
                    )
                );

                evt.target.parentElement.querySelector('dom-repeat').render();

                setTimeout(
                    function () {
                        this.clear();
                    }.bind(evt.target),
                    200
                );
            }

            /**
             *
             */
            submitSidelineResourceButton() {
                this.$.formPanelResource.submit();
            }

            /**
             * @param evt
             */
            submitPanelResource(evt) {
                evt.preventDefault();

                let method = this.getStorageMethod();
                this.storage[method](this.resource)
                    .then((data) => {
                        serviceManager.get('PaperToastNotification').notify(method.charAt(0).toUpperCase() + method.slice(1) + ' video panel resource');
                        if (method === 'save') {
                            this.resetResource();
                        }

                    })
                    .catch((err) => {
                            console.log(err)
                        }
                    );
            }

            /**
             *
             */
            resetResource() {

                this.$.formPanelResource.reset();
                this.hideResourceSection = false;
                this.resource = new PanelResource();
            }

            /**


            _changeSidelineResource(newValue) {

                if (!newValue || !newValue.id) {
                    return;
                }

                let elementsToClear = this.shadowRoot.querySelectorAll('div.listClass');

                for (let cont = 0; elementsToClear.length > cont; cont++) {
                    while (elementsToClear[cont].firstChild) {
                        elementsToClear[cont].removeChild(elementsToClear[cont].firstChild);
                    }
                }


                serviceManager.get('StoragePluginManager')
                    .get(VideoPanelConfig.NAME_SERVICE)
                    .get(newValue.sidelineReference.sidelineId)
                    .then((data) => {

                        this._setSideline(data);
                        this.$.sideline.text = this.sideline.name;
                        this.$.checkSingle.checked = newValue.isSingleSidelineResource();
                        if (this.$.checkSingle.checked ) {
                            for (let cont = 0; newValue.resourcesInSideline[0].resources.length > cont; cont++) {

                                serviceManager.get('StoragePluginManager')
                                    .get(ResourceConfig.NAME_SERVICE)
                                    .get(newValue.resourcesInSideline[0].resources[cont])
                                    .then((data) => {
                                        this.$.singleSidelineResource.appendChild(this._createChip(data));
                                    });
                            }
                        } else {

                            setTimeout(
                                () => {
                                    let elements = this.shadowRoot.querySelectorAll('div[sidelinemultiresource]');
                                    for (let cont = 0; elements.length > cont; cont++) {
                                        let resources = this.sidelineResource.getArrayResourceFromSidelineResource(elements[cont].sideline);

                                        for (let cont2 = 0; resources.length > cont2; cont2++) {

                                            let elementToAppend = elements[cont].querySelector('div.listClass');
                                            serviceManager.get('StoragePluginManager')
                                                .get(ResourceConfig.NAME_SERVICE)
                                                .get(resources[cont2])
                                                .then((data) => {
                                                    elementToAppend.appendChild(this._createChip(data));
                                                });
                                        }
                                    }
                                },
                                300
                            );
                        }
                    });
            }


            submitSidelineResourceButton() {
                this.$.formSidelineResource.submit();
            }


            submitSidelineResource(evt) {
                evt.preventDefault();

                // TODO validation

                this.sidelineResource.sidelineReference = this._generateSidelineReference(this.sideline);
                this.sidelineResource.resourcesInSideline = [];
                let paperChips =  [];
                let resourcesInSideline = {};

                if (this.$.checkSingle.checked) {

                    this.sidelineResource.resourcesInSideline.push(
                        this._generateResourceInSideline(
                            this._generateSidelineReference(this.sideline),
                            this.shadowRoot.querySelectorAll('#singleSidelineResource paper-chip')
                        )
                    );
                } else {
                    let elements = this.shadowRoot.querySelectorAll('div[sidelinemultiresource]');

                    for (let cont = 0; elements.length > cont; cont++) {

                        this.sidelineResource.resourcesInSideline.push(
                            this._generateResourceInSideline(
                                this._generateSidelineReference(elements[cont].sideline, this.sideline),
                                elements[cont].querySelectorAll('paper-chip')
                            )
                        );
                    }
                }

                let method = 'save';
                if (this.sidelineResource.id) {
                    method = 'update';
                }

                serviceManager.get('StoragePluginManager')
                    .get(VideoPanelConfig.RESOURCE_SERVICE)[method](this.sidelineResource)
                    .then((data) => {
                        serviceManager.get('PaperToastNotification').notify(method.charAt(0).toUpperCase() + method.slice(1) + ' sideline resource');
                    })
                    .catch((err) => {
                            console.error(err)
                        }
                    );
            }


            _generateSidelineReference(sideline, parentSideline = null) {
                let reference = new SidelineReference();
                reference.sidelineId = sideline.id;
                reference.name = sideline.name;
                reference.sidelineParentId = (parentSideline !== null) ? parentSideline.id : null;
                return reference;
            }


            _generateResourceInSideline(sidelineReference, paperChips) {

                let resourceInSideline = {
                    sidelineReference : sidelineReference,
                    resources : []
                };

                for (let cont = 0; paperChips.length > cont; cont++) {
                    resourceInSideline.resources.push(paperChips[cont].resource.id);
                }

                return resourceInSideline;
            }


            _clearData(evt) {
                this.$.name.value = null;
                this.$.checkSingle.checked = false;
                this.$.sideline.clear();
                this._setSideline(null);
            }

             */
        }

        window.customElements.define(ElementVideoPanelViewResourceUpsert.is, ElementVideoPanelViewResourceUpsert);

    </script>
</dom-module>
